<script>
    let currentTargetId = ''; 
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyKLaw8tc0SrHxoN5Xn7IUR4FFXG9fT6f6iNOzI73ZBXtNa7i6WXiLFET6W-RIHReE-sg/exec";

    function getThaiDate() {
        const now = new Date();
        const months = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
        return `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear() + 543}`;
    }

    function openEditor(id, title) {
        currentTargetId = id;
        document.getElementById('editor-title').innerText = title;
        document.getElementById('expanded-text').value = document.getElementById(id).value;
        document.getElementById('editorOverlay').style.display = 'flex';
        setTimeout(() => { document.getElementById('expanded-text').focus(); }, 150);
    }

    function closeEditor(isSave) {
        if (isSave) document.getElementById(currentTargetId).value = document.getElementById('expanded-text').value;
        document.getElementById('editorOverlay').style.display = 'none';
    }

    async function processAndSend(text, jsonData) {
        // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
        const outSection = document.getElementById('output-section');
        const outDisplay = document.getElementById('output');
        outDisplay.innerText = text;
        outSection.style.display = 'block';

        // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
        outSection.scrollIntoView({ behavior: 'smooth' });

        // ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        try {
            await navigator.clipboard.writeText(text);
            const hint = document.getElementById('copyHint');
            hint.style.display = 'block';
            setTimeout(() => { hint.style.display = 'none'; }, 2500);
        } catch (err) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
        }

        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ Sheets
        if (GOOGLE_SCRIPT_URL !== "") {
            fetch(GOOGLE_SCRIPT_URL, { 
                method: 'POST', 
                mode: 'no-cors', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(jsonData) 
            });
        }
    }

    function reportFire() {
        let cars = [document.getElementById('fire_car1').value, document.getElementById('fire_car2').value].filter(v => v);
        const text = `${getThaiDate()}\n‡∏™.‡∏î‡∏û.‡∏ö‡∏≤‡∏á‡∏ö‡∏≠‡∏ô\nüî• ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏•‡∏¥‡∏á‡πÑ‡∏´‡∏°‡πâ\n‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ${document.getElementById('fire_place').value || '-'}\n‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏: ${cars.join(', ') || '-'}\n‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á: ${document.getElementById('f_t1').value || '--:--'} ‡∏ô.\n‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏≠‡∏Å: ${document.getElementById('f_t2').value || '--:--'} ‡∏ô.\n‡πÄ‡∏ß‡∏•‡∏≤ ‡∏ß.10: ${document.getElementById('f_t3').value || '--:--'} ‡∏ô.\n‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥: ${document.getElementById('f_t4').value || '--:--'} ‡∏ô.\n‡πÄ‡∏•‡∏¥‡∏Å ‡∏ß.10: ${document.getElementById('f_t5').value || '--:--'} ‡∏ô.\n‡∏ß.4 ‡∏™.‡∏î‡∏û.: ${document.getElementById('f_t6').value || '--:--'} ‡∏ô.\n‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥: ${document.getElementById('fire_team').value || '-'}\n‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ${document.getElementById('fire_sender').value || '-'}`;
        
        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ Database
        processAndSend(text, { 
            type: "‡πÄ‡∏û‡∏•‡∏¥‡∏á‡πÑ‡∏´‡∏°‡πâ", 
            date: getThaiDate(),
            place: document.getElementById('fire_place').value || '-',
            staff: document.getElementById('fire_team').value || '-',
            sender: document.getElementById('fire_sender').value || '-'
        });
    }

    function reportRescue() {
        const text = `${getThaiDate()}\n‡∏™.‡∏î‡∏û.‡∏ö‡∏≤‡∏á‡∏ö‡∏≠‡∏ô\nüêæ ‡πÄ‡∏´‡∏ï‡∏∏‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô\n‡∏ä‡∏ô‡∏¥‡∏î: ${document.getElementById('res_type_text').value || '-'}\n‡∏Ç‡∏ô‡∏≤‡∏î/‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${document.getElementById('res_len_text').value || '-'}\n‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ${document.getElementById('res_place').value || '-'}\n‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏: ${document.getElementById('res_car_single').value || '-'}\n‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á: ${document.getElementById('r_t1').value || '--:--'} ‡∏ô.\n‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏≠‡∏Å: ${document.getElementById('r_t2').value || '--:--'} ‡∏ô.\n‡πÄ‡∏ß‡∏•‡∏≤ ‡∏ß.10: ${document.getElementById('r_t3').value || '--:--'} ‡∏ô.\n‡πÄ‡∏•‡∏¥‡∏Å ‡∏ß.10: ${document.getElementById('r_t4').value || '--:--'} ‡∏ô.\n‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥: ${document.getElementById('res_team').value || '-'}\n‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ${document.getElementById('res_sender').value || '-'}`;
        
        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ Database
        processAndSend(text, { 
            type: "‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô", 
            date: getThaiDate(),
            place: document.getElementById('res_place').value || '-',
            staff: document.getElementById('res_team').value || '-',
            sender: document.getElementById('res_sender').value || '-'
        });
    }
</script>
