<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw-uNZLvttpig1h7PhSK9gI5Icg1JOc2Ttx6r2Y50fTEMQkHfz83TCLXnDwMje7Lp_Xbg/exec";

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    function generateStaff() {
        const containers = {
            fTeam: document.getElementById('fire_team_list'),
            fSend: document.getElementById('fire_sender_list'),
            rTeam: document.getElementById('res_team_list'),
            rSend: document.getElementById('res_sender_list')
        };
        let html = '';
        for (let g = 1; g <= 4; g++) {
            html += `<div class="group-title">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏≤‡∏á‡∏ö‡∏≠‡∏ô ${g}-X</div><div class="staff-grid">`;
            for (let i = 1; i <= 10; i++) {
                const name = `‡∏ö‡∏≤‡∏á‡∏ö‡∏≠‡∏ô ${g}-${i}`;
                html += `<label class="staff-item"><input type="checkbox" class="st-chk" value="${name}"> ${name}</label>`;
            }
            html += `</div>`;
        }
        containers.fTeam.innerHTML = html;
        containers.rTeam.innerHTML = html;
        containers.fSend.innerHTML = html.replace(/type="checkbox" class="st-chk"/g, 'type="radio" name="f_sender"');
        containers.rSend.innerHTML = html.replace(/type="checkbox" class="st-chk"/g, 'type="radio" name="r_sender"');
    }
    generateStaff();

    function getThaiDate() {
        const d = new Date();
        const m = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
        return `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${d.getDate()} ${m[d.getMonth()]} ${d.getFullYear() + 543}`;
    }

    function toggleOther() {
        const s = document.getElementById('res_type_text');
        document.getElementById('res_type_other').style.display = (s.value === '‡πÄ‡∏´‡∏ï‡∏∏‡∏≠‡∏∑‡πà‡∏ô‡πÜ') ? 'block' : 'none';
    }

    let pendingData = null;

    function prepareReport(type) {
        let text = "";
        let json = {};
        const dateStr = getThaiDate();

        if (type === 'fire') {
            const place = document.getElementById('fire_place').value || '-';
            const cars = [
                document.getElementById('fire_car1').value, 
                document.getElementById('fire_car2').value,
                document.getElementById('fire_car3').value
            ].filter(v => v).join(', ') || '-';
            const team = Array.from(document.querySelectorAll('#fire_team_list input:checked')).map(e => e.value).join(', ') || '-';
            const sender = (document.querySelector('input[name="f_sender"]:checked') || {value: '-'}).value;
            const t = { 1: document.getElementById('f_t1').value || '-', 2: document.getElementById('f_t2').value || '-', 3: document.getElementById('f_t3').value || '-', 4: document.getElementById('f_t4').value || '-', 5: document.getElementById('f_t5').value || '-' };

            text = `${dateStr}\n‡∏™.‡∏î‡∏û.‡∏ö‡∏≤‡∏á‡∏ö‡∏≠‡∏ô\nüî• ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏•‡∏¥‡∏á‡πÑ‡∏´‡∏°‡πâ\n------------------\nüìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ${place}\n‚è∞ ‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á: ${t[1]} ‡∏ô\n‚è∞ ‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏≠‡∏Å: ${t[2]} ‡∏ô\n‚è∞ ‡∏ß.10: ${t[3]} ‡∏ô\n‚è∞ ‡πÄ‡∏•‡∏¥‡∏Å ‡∏ß.10: ${t[4]} ‡∏ô\n‚è∞ ‡∏ß.10 ‡∏™.‡∏î‡∏û.: ${t[5]} ‡∏ô\nüöí ‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å: ${cars}\nüë• ‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô: ${team}\nüì¢ ‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ${sender}`;
            json = { type: "‡πÄ‡∏û‡∏•‡∏¥‡∏á‡πÑ‡∏´‡∏°‡πâ", date: dateStr, place: place, len: "-", staff: team, sender: sender, t1: t[1], t2: t[2], t3: t[3], t4: t[4], t5: t[5], car: cars };
        } else {
            let animal = document.getElementById('res_type_text').value;
            if(animal === '‡πÄ‡∏´‡∏ï‡∏∏‡∏≠‡∏∑‡πà‡∏ô‡πÜ') animal = document.getElementById('res_type_other').value || '‡πÄ‡∏´‡∏ï‡∏∏‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
            const place = document.getElementById('res_place').value || '-';
            const size = document.getElementById('res_len_text').value || '-';
            const car = document.getElementById('res_car_single').value || '-';
            const team = Array.from(document.querySelectorAll('#res_team_list input:checked')).map(e => e.value).join(', ') || '-';
            const sender = (document.querySelector('input[name="r_sender"]:checked') || {value: '-'}).value;
            const t = { 1: document.getElementById('r_t1').value || '-', 2: document.getElementById('r_t2').value || '-', 3: document.getElementById('r_t3').value || '-', 4: document.getElementById('r_t4').value || '-', 5: document.getElementById('r_t5').value || '-' };

            text = `${dateStr}\n‡∏™.‡∏î‡∏û.‡∏ö‡∏≤‡∏á‡∏ö‡∏≠‡∏ô\nüêæ ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (${animal})\n------------------\nüìè ‡∏Ç‡∏ô‡∏≤‡∏î: ${size}\nüìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ${place}\n‚è∞ ‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á: ${t[1]} ‡∏ô\n‚è∞ ‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏≠‡∏Å: ${t[2]} ‡∏ô\n‚è∞ ‡∏ß.10: ${t[3]} ‡∏ô\n‚è∞ ‡πÄ‡∏•‡∏¥‡∏Å ‡∏ß.10: ${t[4]} ‡∏ô\n‚è∞ ‡∏ß.10 ‡∏™.‡∏î‡∏û.: ${t[5]} ‡∏ô\nüöí ‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å: ${car}\nüë• ‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô: ${team}\nüì¢ ‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ${sender}`;
            json = { type: `501 (${animal})`, date: dateStr, place: place, len: size, staff: team, sender: sender, t1: t[1], t2: t[2], t3: t[3], t4: t[4], t5: t[5], car: car };
        }

        pendingData = { text, json };
        document.getElementById('previewBody').innerText = text;
        document.getElementById('previewOverlay').style.display = 'flex';
        document.getElementById('btnConfirmSend').onclick = sendFinal;
    }

    function closePreview() { document.getElementById('previewOverlay').style.display = 'none'; }

    async function sendFinal() {
        if (!pendingData) return;
        const btn = document.getElementById('btnConfirmSend');
        const originalText = btn.innerText;
        
        // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á
        btn.disabled = true;
        btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
        btn.classList.replace('bg-green-600', 'bg-gray-500');

        const { text, json } = pendingData;
        
        // 1. ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏á‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ö‡∏≠‡∏£‡πå‡∏î
        try {
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
        } catch (e) {}

        // 2. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ Google Sheets
        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify(json)
        }).then(() => {
            const hint = document.getElementById('copyHint');
            hint.style.display = 'block';
            setTimeout(() => { hint.style.display = 'none'; }, 2500);
            closePreview();
        }).catch(err => {
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠");
            console.error(err);
        }).finally(() => {
            // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°
            btn.disabled = false;
            btn.innerText = originalText;
            btn.classList.replace('bg-gray-500', 'bg-green-600');
        });
    }
</script>
