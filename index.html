<script>
    let currentTargetId = ''; 
    let pendingReportData = null;
    // URL à¹€à¸”à¸´à¸¡à¸‚à¸­à¸‡à¸„à¸¸à¸“
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyrnIxDMSXLPdIVlZjX9gx8t2eoG1_TDCKQ0SmfK3mhlbD42T6_gUGrf-0OGUdTB6jLZg/exec";

    function getThaiDate() {
        const now = new Date();
        const months = ["à¸¡à¸à¸£à¸²à¸„à¸¡", "à¸à¸¸à¸¡à¸ à¸²à¸žà¸±à¸™à¸˜à¹Œ", "à¸¡à¸µà¸™à¸²à¸„à¸¡", "à¹€à¸¡à¸©à¸²à¸¢à¸™", "à¸žà¸¤à¸©à¸ à¸²à¸„à¸¡", "à¸¡à¸´à¸–à¸¸à¸™à¸²à¸¢à¸™", "à¸à¸£à¸à¸Žà¸²à¸„à¸¡", "à¸ªà¸´à¸‡à¸«à¸²à¸„à¸¡", "à¸à¸±à¸™à¸¢à¸²à¸¢à¸™", "à¸•à¸¸à¸¥à¸²à¸„à¸¡", "à¸žà¸¤à¸¨à¸ˆà¸´à¸à¸²à¸¢à¸™", "à¸˜à¸±à¸™à¸§à¸²à¸„à¸¡"];
        return `à¸§à¸±à¸™à¸—à¸µà¹ˆ ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear() + 543}`;
    }

    function toggleOtherInput() {
        const select = document.getElementById('res_type_text');
        const otherInput = document.getElementById('res_type_other');
        otherInput.style.display = (select.value === 'à¹€à¸«à¸•à¸¸à¸­à¸·à¹ˆà¸™à¹†') ? 'block' : 'none';
    }

    function openTextEditor(id, title) {
        currentTargetId = id;
        document.getElementById('editor-title').innerText = title;
        document.getElementById('expanded-text').value = document.getElementById(id).value;
        document.getElementById('editorOverlay').style.display = 'flex';
        setTimeout(() => { document.getElementById('expanded-text').focus(); }, 150);
    }

    function closeTextEditor(isSave) {
        if (isSave) document.getElementById(currentTargetId).value = document.getElementById('expanded-text').value;
        document.getElementById('editorOverlay').style.display = 'none';
    }

    function prepareReport(type) {
        let text = "";
        let jsonData = {};

        if (type === 'fire') {
            const cars = [document.getElementById('fire_car1').value, document.getElementById('fire_car2').value, document.getElementById('fire_car3').value].filter(v => v);
            const carList = cars.join(', ') || '-';
            const place = document.getElementById('fire_place').value || '-';
            const sender = document.getElementById('fire_sender').value || '-';
            const team = document.getElementById('fire_team').value || '-';
            const t = {
                1: document.getElementById('f_t1').value || '-',
                2: document.getElementById('f_t2').value || '-',
                3: document.getElementById('f_t3').value || '-',
                4: document.getElementById('f_t4').value || '-',
                5: document.getElementById('f_t5').value || '-'
            };

            text = `${getThaiDate()}\nà¸ª.à¸”à¸ž.à¸šà¸²à¸‡à¸šà¸­à¸™\nðŸ”¥ à¸£à¸²à¸¢à¸‡à¸²à¸™à¹€à¸«à¸•à¸¸à¹€à¸žà¸¥à¸´à¸‡à¹„à¸«à¸¡à¹‰\n------------------\nðŸ“ à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ: ${place}\nâ° à¸£à¸±à¸šà¹à¸ˆà¹‰à¸‡: ${t[1]} à¸™\nâ° à¹à¸ˆà¹‰à¸‡à¸­à¸­à¸: ${t[2]} à¸™\nâ° à¸§.10: ${t[3]} à¸™\nâ° à¹€à¸¥à¸´à¸ à¸§.10: ${t[4]} à¸™\nâ° à¸§.10 à¸ª.à¸”à¸ž.: ${t[5]} à¸™\nðŸš’ à¸£à¸–à¸—à¸µà¹ˆà¸­à¸­à¸: ${carList}\nðŸ‘¥ à¸œà¸¹à¹‰à¸›à¸à¸´à¸šà¸±à¸•à¸´à¸‡à¸²à¸™: ${team}\nðŸ“¢ à¸œà¸¹à¹‰à¸£à¸²à¸¢à¸‡à¸²à¸™: ${sender}`;
            
            // à¸›à¸£à¸±à¸š jsonData à¹ƒà¸«à¹‰à¸¡à¸µà¹‚à¸„à¸£à¸‡à¸ªà¸£à¹‰à¸²à¸‡à¹€à¸—à¹ˆà¸²à¸à¸±à¸šà¸à¸±à¹ˆà¸‡à¸Šà¹ˆà¸§à¸¢à¹€à¸«à¸¥à¸·à¸­ (à¹€à¸žà¸´à¹ˆà¸¡ len: "-")
            jsonData = { 
                type: "à¹€à¸žà¸¥à¸´à¸‡à¹„à¸«à¸¡à¹‰", 
                date: getThaiDate(), 
                place: place, 
                len: "-", 
                staff: team, 
                sender: sender, 
                t1: t[1], t2: t[2], t3: t[3], t4: t[4], t5: t[5], 
                car: carList 
            };
        } else {
            let animal = document.getElementById('res_type_text').value;
            if(animal === 'à¹€à¸«à¸•à¸¸à¸­à¸·à¹ˆà¸™à¹†') animal = document.getElementById('res_type_other').value || 'à¹€à¸«à¸•à¸¸à¸­à¸·à¹ˆà¸™à¹†';
            const car = document.getElementById('res_car_single').value || '-';
            const size = document.getElementById('res_len_text').value || '-';
            const place = document.getElementById('res_place').value || '-';
            const sender = document.getElementById('res_sender').value || '-';
            const team = document.getElementById('res_team').value || '-';
            const t = {
                1: document.getElementById('r_t1').value || '-',
                2: document.getElementById('r_t2').value || '-',
                3: document.getElementById('r_t3').value || '-',
                4: document.getElementById('r_t4').value || '-',
                5: document.getElementById('r_t5').value || '-'
            };

            text = `${getThaiDate()}\nà¸ª.à¸”à¸ž.à¸šà¸²à¸‡à¸šà¸­à¸™\nðŸ¾ à¸Šà¹ˆà¸§à¸¢à¹€à¸«à¸¥à¸·à¸­à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™ (${animal})\n------------------\nðŸ“ à¸‚à¸™à¸²à¸”: ${size}\nðŸ“ à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ: ${place}\nâ° à¸£à¸±à¸šà¹à¸ˆà¹‰à¸‡: ${t[1]} à¸™\nâ° à¹à¸ˆà¹‰à¸‡à¸­à¸­à¸: ${t[2]} à¸™\nâ° à¸§.10: ${t[3]} à¸™\nâ° à¹€à¸¥à¸´à¸ à¸§.10: ${t[4]} à¸™\nâ° à¸§.10 à¸ª.à¸”à¸ž.: ${t[5]} à¸™\nðŸš’ à¸£à¸–à¸—à¸µà¹ˆà¸­à¸­à¸: ${car}\nðŸ‘¥ à¸œà¸¹à¹‰à¸›à¸à¸´à¸šà¸±à¸•à¸´à¸‡à¸²à¸™: ${team}\nðŸ“¢ à¸œà¸¹à¹‰à¸£à¸²à¸¢à¸‡à¸²à¸™: ${sender}`;

            jsonData = { 
                type: `à¸Šà¹ˆà¸§à¸¢à¹€à¸«à¸¥à¸·à¸­ (${animal})`, 
                date: getThaiDate(), 
                place: place, 
                len: size, 
                staff: team, 
                sender: sender, 
                t1: t[1], t2: t[2], t3: t[3], t4: t[4], t5: t[5], 
                car: car 
            };
        }

        pendingReportData = { text, jsonData };
        document.getElementById('previewBody').innerText = text;
        document.getElementById('previewOverlay').style.display = 'flex';
        
        document.getElementById('btnConfirmSend').onclick = function() {
            finalSend();
        };
    }

    function closePreview() {
        document.getElementById('previewOverlay').style.display = 'none';
        pendingReportData = null;
    }

    async function finalSend() {
        if (!pendingReportData) return;
        const { text, jsonData } = pendingReportData;

        // à¸„à¸±à¸”à¸¥à¸­à¸à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡
        try {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);

            const hint = document.getElementById('copyHint');
            hint.style.display = 'block';
            setTimeout(() => { hint.style.display = 'none'; }, 2500);
        } catch (err) { console.error(err); }

        // à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸›à¸¢à¸±à¸‡ Google Sheets
        if (GOOGLE_SCRIPT_URL !== "") {
            fetch(GOOGLE_SCRIPT_URL, { 
                method: 'POST', 
                mode: 'no-cors', 
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(jsonData) 
            });
        }
        closePreview();
    }
</script>
